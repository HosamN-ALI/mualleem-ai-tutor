# خطة الاختبارات الشاملة لمشروع معلّم (`.next-tasks.md`)

## 0. مقدمة

- هدف هذا الملف: إعطاء المبرمج/فريق الاختبار خطة عمل تفصيلية لاختبار النظام كاملاً (Backend + Frontend + التكامل مع Requesty/Qdrant) قبل التسليم أو أول إطلاق حقيقي.
- نطاق الاختبارات:
  - واجهة موعلّم (Next.js – Arabic UI).
  - Backend FastAPI (RAG + Qdrant + Requesty).
  - تكامل الواجهة مع الـ API.
  - الجوانب الأساسية للأداء والأمان والقبول.

---

## 1. اختبارات الخصائص والوظائف (Features & Functionality Testing)

### 1.1 حصر الخصائص الأساسية في المشروع

فيما يلي قائمة منظمة بالخصائص الحالية (مع تحديثها بناءً على الكود والوثائق إن لزم):

1. **الدردشة النصية مع المعلّم الذكي**
   - الوصف: إدخال سؤال نصي في واجهة المحادثة والحصول على إجابة من الـ LLM عبر Requesty، مع إمكانية تضمين سياق من RAG إذا توفّر.
   - المسار:
     - واجهة: مكوّن [`ChatInterface`](mualleem-ai-tutor/frontend/components/ChatInterface.tsx:1)
     - Backend: مسار POST `/chat` في [`main.py`](mualleem-ai-tutor/backend/main.py:1) عبر خدمة RAG/Requesty.

2. **الدردشة مع صورة (مسألة مصوَّرة)**
   - الوصف: رفع صورة لمسألة (مثلاً سؤال رياضيات مكتوب بخط اليد أو مطبوع) مع نص إضافي اختياري، ثم إرسالها إلى `/chat` للحصول على تحليل/حل من المعلّم الذكي.
   - المسار:
     - واجهة: نفس مكوّن [`ChatInterface`](mualleem-ai-tutor/frontend/components/ChatInterface.tsx:1) عند اختيار/رفع صورة.
     - Backend: مسار `/chat` مع حقل `image` (ملف) بالإضافة إلى `question`.

3. **رفع منهج PDF وفهرسته (RAG Ingestion)**
   - الوصف: رفع ملف PDF للمنهج ليتم:
     - تقطيعه إلى مقاطع (chunks).
     - توليد embeddings باستخدام نموذج `openai/text-embedding-3-large` عبر Requesty.
     - تخزين النتائج في Qdrant ضمن collection باسم `mualleem_curriculum`.
   - المسار:
     - عميل/أداة (curl أو سكربت) أو واجهة رفع مخصّصة لاحقاً.
     - Backend: مسار (مثال) POST `/upload-curriculum` كما هو موثّق في:
       - [`RAG_IMPLEMENTATION.md`](mualleem-ai-tutor/backend/RAG_IMPLEMENTATION.md:1)
       - وظائف RAG في [`rag_service.py`](mualleem-ai-tutor/backend/rag_service.py:1) و[`rag_engine.py`](mualleem-ai-tutor/backend/rag_engine.py:1).

4. **استعلام RAG عن المنهج**
   - الوصف: إرسال سؤال يعتمد على محتوى PDF المفهرس واسترجاع إجابة مدعومة بسياق من Qdrant:
     - البحث عن المقاطع الأقرب للسؤال.
     - تمرير السياق مع السؤال إلى نموذج المحادثة عبر Requesty.
   - المسار:
     - Backend: `/chat` مع تفعيل وضع RAG داخل خدمة [`rag_service`](mualleem-ai-tutor/backend/rag_service.py:1) و[`rag_engine`](mualleem-ai-tutor/backend/rag_engine.py:1).
     - Qdrant: collection `mualleem_curriculum`.

5. **نقاط نهاية المراقبة (Monitoring Endpoints)**
   - `/health`:
     - للتحقق من أن الخدمة الأساسية تعمل (FastAPI + الاتصال الأولي بمكوّنات حرجة إذا لزم).
   - `/stats`:
     - لعرض إحصائيات مثل:
       - عدد الـ chunks المخزّنة.
       - حالة الاتصال بـ Qdrant.
       - معلومات عن آخر عملية فهرسة منهج.

6. **إعدادات CORS والاتصال عبر IP عام**
   - الوصف:
     - الوصول للواجهة عبر `http://216.81.248.146:3002`.
     - تكامل الواجهة مع backend على `http://216.81.248.146:8000`.
   - النقاط التي يجب اختبارها:
     - السماح للمتصفح بطلبات cross-origin الصحيحة (CORS).
     - عدم وجود حظر للطلبات بسبب CORS misconfiguration.
     - عمل الاتصال عبر IP عام من أجهزة مختلفة.

7. **خصائص إضافية (يتم تحديثها عند اللزوم)**
   - مثلاً:
     - إدارة المستخدم (إن وُجدت حالياً أو مستقبلاً): تسجيل دخول، صلاحيات، جلسات.
     - إعدادات لغة/ثيم الواجهة.
     - أي Endpoints إضافية تم توثيقها في:
       - [`ARCHITECTURE.md`](mualleem-ai-tutor/ARCHITECTURE.md:1)
       - [`REQUESTY_INTEGRATION.md`](mualleem-ai-tutor/REQUESTY_INTEGRATION.md:1)
       - [`FRONTEND_COMPLETE.md`](mualleem-ai-tutor/FRONTEND_COMPLETE.md:1)

### 1.2 حالات الاختبار لكل خاصية (Test Cases)

يتم تعريف Test Cases بصيغة موحدة. أمثلة مبدئية (ويُستكمل الملف لاحقاً بالاختبارات التفصيلية):

---

#### الدردشة النصية

- **TC-F-01: سؤال نصي بسيط**
  - الخاصية: الدردشة النصية.
  - البيئة:
    - Frontend يعمل على: `http://216.81.248.146:3002`.
    - Backend يعمل على: `http://216.81.248.146:8000`.
  - الخطوات:
    1. افتح واجهة موعلّم على `http://216.81.248.146:3002`.
    2. في حقل النص الرئيسي، اكتب: `ما هي مشتقة x^2 ؟`.
    3. اضغط زر "إرسال".
  - المدخلات المتوقعة:
    - طلب HTTP POST إلى `/chat` يحتوي JSON شبيه بـ:
      ```json
      {
        "question": "ما هي مشتقة x^2 ؟",
        "image": null
      }
      ```
  - المخرجات المتوقعة:
    - استجابة HTTP 200 من `/chat`.
    - JSON يحتوي حقل `answer` باللغة العربية مع إجابة رياضية صحيحة تقريباً (مثل: `"مشتقة x^2 هي 2x"`).
  - معايير النجاح:
    - لا توجد أخطاء في console المتصفح متعلقة بالطلب (CORS/Network/JS Error).
    - لا تظهر رسالة خطأ في الواجهة للمستخدم.
    - زمن الاستجابة أقل من 5 ثوانٍ (يمكن ضبط القيمة بناءً على البيئة).
    - لا يحدث refresh غير متوقع للصفحة.
    - رسالة الطالب والرسالة من المعلّم تظهران بشكل صحيح في واجهة المحادثة.

- **TC-F-02: سؤال مع صورة (صحيحة)**
  - الخاصية: الدردشة مع صورة.
  - الخطوات:
    1. افتح واجهة موعلّم على `http://216.81.248.146:3002`.
    2. اضغط زر/أيقونة رفع الصورة في واجهة المحادثة.
    3. اختر صورة لمسألة رياضية واضحة (صيغة PNG أو JPG، حجم < 5MB مثلاً).
    4. اكتب في حقل النص: `حل المسألة الموجودة في الصورة بالتفصيل`.
    5. اضغط زر "إرسال".
  - المدخلات المتوقعة:
    - طلب HTTP (Multipart أو JSON مع base64 حسب التنفيذ) إلى `/chat` يحتوي:
      - `question="حل المسألة الموجودة في الصورة بالتفصيل"`.
      - `image=<ملف الصورة>`.
  - المخرجات المتوقعة:
    - استجابة HTTP 200 من `/chat`.
    - JSON يحتوي:
      - `answer`: شرح أو حل منطقي للمسألة الظاهرة في الصورة.
      - إن وُجد: `used_image=true` أو أي حقل يدل على أن الصورة استُخدمت في التحليل (بحسب التصميم).
  - معايير النجاح:
    - قبول الملف بدون خطأ (نوع وحجم مدعوم).
    - ظهور معاينة مصغّرة للصورة في واجهة المحادثة (إن كان هذا سلوكاً مطلوباً).
    - عدم ظهور أخطاء في console.
    - زمن الاستجابة في حدود مقبولة (قد تكون أعلى قليلاً بسبب معالجة الصورة، مثال < 8 ثوانٍ).

- **TC-F-03: سؤال نصي مع صورة غير مدعومة**
  - الخاصية: الدردشة مع صورة.
  - الهدف: التحقق من التعامل مع ملفات غير مدعومة (مثلاً `.exe` أو حجم ضخم جداً).
  - الخطوات:
    1. حاول رفع ملف غير صورة (مثل PDF أو ملف تنفيذي) من واجهة رفع الصورة.
    2. أو ملف صورة بحجم يتجاوز الحد الأقصى المسموح.
  - المخرجات المتوقعة:
    - رفض الرفع مع رسالة خطأ عربية واضحة للمستخدم توضح سبب الرفض (نوع الملف أو حجمه).
    - عدم إرسال الطلب إلى `/chat` أساساً، أو إرسال رد خطأ 4xx من backend مع وصف.
  - معايير النجاح:
    - لا يتوقف التطبيق أو يتجمّد.
    - لا يتم حفظ ملف غير صالح في السيرفر.
    - لا توجد أخطاء غير مفسّرة في console.

---

#### رفع PDF عبر `/upload-curriculum`

- **TC-F-04: رفع PDF صحيح عبر `/upload-curriculum`**
  - الخاصية: فهرسة المنهج (RAG Ingestion).
  - الخطوات:
    1. حضّر ملف PDF متوسط الحجم (مثلاً 20–50 صفحة) يحتوي نصوصاً تعليمية واضحة.
    2. نفّذ الأمر التالي (كمثال باستخدام `curl`) من بيئة الاختبار:
       ```bash
       curl -X POST "http://216.81.248.146:8000/upload-curriculum" \
         -F "file=@path/to/curriculum.pdf"
       ```
    3. بعد نجاح الطلب، استدعِ:
       ```bash
       curl "http://216.81.248.146:8000/stats"
       ```
  - المدخلات:
    - `file=@path/to/curriculum.pdf`.
  - المخرجات المتوقعة:
    - من `/upload-curriculum`:
      - استجابة JSON تحتوي على معلومات مثل:
        - عدد الـ chunks التي تم توليدها `total_chunks`.
        - عدد الـ embeddings التي تم تخزينها في Qdrant.
        - وقت المعالجة التقريبي.
    - من `/stats`:
      - ظهور زيادة في `total_chunks` أو القيمة المناظرة بعد الرفع بالمقارنة مع القيمة السابقة.
  - حالات الحافة:
    - **TC-F-05: PDF فارغ أو شبه فارغ**
      - رفع PDF بحجم صغير جداً ولا يحتوي نصاً.
      - المخرجات المتوقعة: رسالة تحذيرية أو خطأ منطقي (لا يمكن فهرسة محتوى فارغ)، مع عدم تخزين نقاط غير مفيدة في Qdrant.
    - **TC-F-06: PDF حجمه كبير جداً**
      - رفع ملف كبير (مثلاً > 50MB) أو عدد صفحات كبير.
      - التوقّع:
        - إما قبول مع وقت معالجة أطول وتجزئة مناسبة.
        - أو رفض مع رسالة واضحة عن تجاوز الحد الأقصى للحجم/الصفحات.
    - **TC-F-07: ملف ليس PDF**
      - رفع ملف نصي أو صورة باسم يمتد بـ `.pdf` أو امتداد آخر.
      - التوقع:
        - فحص نوع الملف فعلياً قدر الإمكان.
        - رفض غير الـ PDF برسالة خطأ واضحة.

---

#### استعلام RAG عن المنهج

- **TC-F-08: سؤال يعتمد على منهج مفهرس**
  - الشرط المسبق:
    - تم رفع PDF للمنهج بنجاح (مثبت بـ `/stats`).
  - الخطوات:
    1. من واجهة الدردشة، اسأل سؤالاً يعتمد على محتوى معروف في الـ PDF، مثل:
       - `اشرح لي تعريف المشتقة كما ورد في منهج الصف الثاني الثانوي`.
    2. أرسل السؤال.
  - المخرجات المتوقعة:
    - استجابة 200 من `/chat`.
    - وجود حقل في JSON (حسب التصميم) مثل:
      - `context_chunks`: يحتوي نصوص المقاطع التي تم استرجاعها من Qdrant.
      - `answer`: إجابة تستخدم هذا السياق (أو تشير إليه).
  - معايير النجاح:
    - الإجابة منطقية وتعكس محتوى المنهج قدر الإمكان.
    - إن لم يكن هناك سياق مناسب، يتم توضيح ذلك في الإجابة بطريقة لطيفة (بدل إجابة خاطئة).

- **TC-F-09: سؤال عن شيء غير موجود في المنهج**
  - الهدف: التحقق من سلوك RAG عند عدم وجود سياق ملائم.
  - الخطوات:
    1. اسأل سؤالاً خارج نطاق المنهج، مثل: `ما هي عاصمة اليابان؟`.
  - المخرجات المتوقعة:
    - إجابة عامة من النموذج بدون اعتماد على سياق Qdrant، أو
    - رسالة توضح أن السؤال لا يرتبط بالمنهج المرفوع (بحسب التصميم المتفق عليه).

---

#### نقاط نهاية المراقبة

- **TC-F-10: التحقق من `/health`**
  - الخطوات:
    1. استدعِ:
       ```bash
       curl "http://216.81.248.146:8000/health"
       ```
  - المخرجات المتوقعة:
    - استجابة 200.
    - JSON بسيط مثل: `{ "status": "ok" }` أو ما يطابق التصميم الفعلي.
  - حالات الحافة:
    - التحقق من أن `/health` يعطي حالة غير 200 عند فشل مكوّن حرج (إذا كان ذلك متضمناً في الكود).

- **TC-F-11: التحقق من `/stats`**
  - الخطوات:
    1. استدعِ:
       ```bash
       curl "http://216.81.248.146:8000/stats"
       ```
  - المخرجات المتوقعة:
    - JSON يحتوي معلومات عن:
      - عدد الـ chunks.
      - حالة الاتصال بـ Qdrant.
      - آخر وقت فهرسة.
    - يتم تحديث القيم بعد كل عملية `/upload-curriculum` ناجحة.

---

#### حالات الخطأ العامة

- **TC-F-12: Requesty غير متاح**
  - السيناريو:
    - إيقاف الاتصال بـ Requesty (مثلاً تغيير `REQUESTY_BASE_URL` مؤقتاً أو قطع الشبكة).
  - الخطوات:
    1. أرسل سؤال نصي عادي عبر `/chat`.
  - المخرجات المتوقعة:
    - استجابة 5xx أو 4xx من backend مع `error` واضح في JSON.
    - في الواجهة: رسالة عربية توضّح أن خدمة الذكاء الاصطناعي غير متاحة مؤقتاً.
  - معايير النجاح:
    - لا انهيار للتطبيق.
    - لا تظهر Stack trace خام للمستخدم النهائي.

- **TC-F-13: Qdrant غير متاح**
  - السيناريو:
    - تعطيل Qdrant أو تغيير `QDRANT_URL` مؤقتاً.
  - الخطوات:
    1. حاول رفع منهج عبر `/upload-curriculum`.
    2. أو اسأل سؤالاً يعتمد على RAG.
  - المخرجات المتوقعة:
    - رسالة خطأ واضحة في JSON والواجهة.
    - عدم ضياع البيانات أو خروج استثناء غير معالَج على مستوى FastAPI.

---

## 2. اختبارات الواجهة الأمامية (UI/UX Testing)

### 2.1 التحقق من عناصر الواجهة

إنشاء قائمة تحقق لعناصر واجهة المستخدم (في صفحة المحادثة الرئيسية):

- الأزرار:
  - زر "إرسال" السؤال.
  - زر/أيقونة رفع الصورة.
  - زر/أزرار إضافية (مثل إعادة المحاولة، حذف المحادثة، إن وُجدت).
  - زر/أيقونة رفع منهج PDF (إن تم تقديم هذه الواجهة في المستقبل).
- حقول الإدخال:
  - حقل النص الرئيسي للسؤال (input أو textarea).
  - أي حقول إعداد أخرى (إن وجدت).
- الرسائل:
  - رسائل النظام (مثل رسائل الانتظار، "جاري التحميل...").
  - رسائل الأخطاء (عدم توفّر الخدمة، خطأ في رفع الملف، ...).
  - التنبيهات/التحذيرات (مثلاً عند رفع نوع ملف غير مدعوم).
- الروابط والقوائم:
  - روابط إلى صفحات مساعدة/وثائق (إن وُجدت).
  - قوائم إعدادات أو menu جانبية.

لكل عنصر:

- التحقق من العرض:
  - أن اتجاه النص RTL ملائم للغة العربية.
  - أن الخط (مثل Cairo) مستخدم ومتناسق في جميع العناصر.
  - أن الألوان متناسقة مع هوية موعلّم ولا تؤثر على إمكانية القراءة.
- التفاعل:
  - حالة hover على الأزرار:
    - تغيّر لون الخلفية أو الإطار بشكل واضح.
  - حالة disabled:
    - إيقاف زر "إرسال" في حالة عدم وجود نص، أو أثناء الإرسال (loading).
  - حالة loading:
    - ظهور مؤشر تحميل عند انتظار استجابة `/chat`.

### 2.2 Responsive Design

تحديد الأجهزة/الأحجام المستهدفة:

- **موبايل:**
  - 375x667 (مثال iPhone 8).
  - 414x896 (مثال iPhone 11 Pro Max).
- **تابلت:**
  - 768x1024 (مثال iPad عمودي).
- **Desktop:**
  - ≥ 1280x720 (شاشة لابتوب قياسية).

لكل حجم شاشة:

- التحقق من:
  - عدم خروج النصوص أو الأزرار خارج الشاشة أفقياً (no horizontal scroll إلا للضرورة).
  - أن input المحادثة يبقى في أسفل الشاشة ويمكن الوصول إليه بسهولة.
  - أن الفقاعات (chat bubbles) تظهر بترتيب منطقي وواضح.
  - أن الأيقونات (رفع صورة، إرسال) تبقى واضحة وقابلة للنقر.

### 2.3 User Flow

تعريف المسارات الرئيسية:

1. **مسار: فتح المنصة → إرسال أول سؤال**
   - الخطوات:
     1. فتح `http://216.81.248.146:3002` لأول مرة.
     2. قراءة أي رسالة ترحيبية (إن وجدت).
     3. كتابة سؤال بسيط.
     4. إرسال السؤال.
     5. استلام الإجابة.
   - تقييم:
     - وضوح مكان الكتابة.
     - وضوح زر الإرسال.
     - وضوح الفرق بين رسائل المستخدم والرسائل من المعلّم الذكي.

2. **مسار: فتح المنصة → رفع PDF → انتظار الفهرسة → طرح سؤال عن المنهج**
   - الخطوات:
     1. فتح الواجهة/أدوات رفع المنهج (إن كانت ضمن الـ UI أو عبر سكربت موثّق).
     2. رفع ملف PDF واحد على الأقل.
     3. انتظار انتهاء العملية (مع رسالة حالة إن وُجدت).
     4. التأكد من `/stats` أن المنهج تم فهرسته.
     5. فتح واجهة المحادثة (إن لم تكن نفسها).
     6. طرح سؤال مرتبط بالمنهج.
   - تقييم:
     - وضوح الخطوات للمستخدم (تعليمات، رسائل، تنبيهات).
     - سهولة تتبّع حالة الفهرسة (progress/نجاح/فشل).

### 2.4 الرسائل والتجربة العربية

- التحقق من أن:
  - جميع الرسائل الظاهرة للمستخدم بالعربية وواضحة لغوياً.
  - لا توجد رسائل إنكليزية غير مفهومة للمستخدم النهائي (إلا إذا كان ذلك مقصوداً).
- أمثلة لرسائل يجب التحقق منها:
  - رسالة توجيه المستخدم:  
    - "رفع ملفات PDF للمنهج يتم من صفحة إعداد المنهج، أما هنا فيمكن رفع صور فقط."
  - رسائل عدم وجود بيانات في Qdrant:
    - مثلاً: "لم يتم العثور على منهج مفهرس بعد، يرجى رفع المنهج أولاً."
- التحقق من:
  - عدم ظهور رسائل الخطأ في غير وقتها (مثلاً بعد نجاح العملية).
  - ارتباط الرسالة بسياق الإجراء الذي قام به المستخدم.

---

## 3. اختبارات التكامل (Integration Testing)

### 3.1 تكامل Frontend مع Backend

يتم اختبار السيناريوهات التالية من خلال الواجهة مع مراقبة Network في المتصفح و/أو اللوغ في backend:

- **سيناريو 1: `/chat` مع نص فقط**
  - إرسال سؤال نصي بسيط من الواجهة.
  - التحقق من:
    - شكل الـ JSON المرسل (يحمل `question` فقط).
    - شكل الـ JSON المستقبَل:
      - حقول مثل: `answer`, `error` (إن وُجد).
      - الترميز UTF-8 بشكل صحيح للنص العربي.

- **سيناريو 2: `/chat` مع نص + صورة**
  - إرسال سؤال مع صورة كما في TC-F-02.
  - التحقق من:
    - أن الطلب يمر عبر واجهة المكوّن [`ChatInterface`](mualleem-ai-tutor/frontend/components/ChatInterface.tsx:1) بالشكل الصحيح.
    - أن الـ backend يستقبل الصورة والنص ويتعامل معهما بدون أخطاء.

- **سيناريو 3: `/upload-curriculum` → `/stats` → `/chat`**
  - رفع منهج PDF كما في TC-F-04.
  - التحقق من `/stats` للتأكّد من تسجيل الفهرسة.
  - إرسال سؤال عن محتوى المنهج من الواجهة.
  - التحقق من:
    - أن RAG تستخدم بيانات Qdrant بالفعل (بناءً على `context_chunks` أو حقول أخرى).
    - عدم ظهور أخطاء في التكامل بين المكوّنات.

- **التحقق من رسائل الأخطاء والتعامل مع HTTP Status Codes**
  - محاكاة أخطاء 4xx/5xx من backend (بتعديل مؤقت أو عن طريق إدخال خاطئ).
  - التأكد من:
    - أن الواجهة تعرض رسالة مفهومة للمستخدم.
    - عدم إظهار JSON خام أو stack trace.

### 3.2 تكامل Backend مع Requesty.ai

الملفات ذات الصلة:

- [`test_requesty.py`](mualleem-ai-tutor/backend/test_requesty.py:1)
- [`test_rag.py`](mualleem-ai-tutor/backend/test_rag.py:1)
- توثيق Requesty في [`REQUESTY_INTEGRATION.md`](mualleem-ai-tutor/REQUESTY_INTEGRATION.md:1).

نقاط التحقق:

- استخدام نموذج `openai/text-embedding-3-large` للـ embeddings في سياق RAG.
- استخدام نماذج المحادثة:
  - `gpt-4o` و/أو `gpt-4o-mini` للمسارات المختلفة:
    - مثلاً:
      - `gpt-4o` للأسئلة المعقّدة أو عند استخدام سياق RAG.
      - `gpt-4o-mini` للأسئلة البسيطة لتقليل التكلفة.
- التأكد من:
  - تمرير الـ API key والـ base URL من `.env` بشكل صحيح.
  - التعامل مع أخطاء Requesty (timeouts، أخطاء مصادقة، ...).
  - عدم تسريب مفاتيح/تفاصيل حسّاسة في رسائل الخطأ الظاهرة للمستخدم.

### 3.3 تكامل Backend مع Qdrant Cloud

الملفات ذات الصلة:

- [`test_qdrant.py`](mualleem-ai-tutor/backend/test_qdrant.py:1)
- وثائق Qdrant في:
  - [`QDRANT_SETUP_EN.md`](mualleem-ai-tutor/QDRANT_SETUP_EN.md:1)
  - [`QDRANT_MIGRATION.md`](mualleem-ai-tutor/QDRANT_MIGRATION.md:1)
  - [`QDRANT_QUICKSTART.md`](mualleem-ai-tutor/QDRANT_QUICKSTART.md:1)

نقاط التحقق:

- إمكانية الاتصال بـ Qdrant Cloud عبر `QDRANT_URL` و `QDRANT_API_KEY`.
- التأكد من:
  - إنشاء/قراءة collection `mualleem_curriculum` بنجاح.
  - نجاح عمليات:
    - upsert (أو ما يكافئها).
    - search / search_points بعد فهرسة PDF.
- اختبار:
  - رد الفعل عند عدم وجود collection (إنشاء تلقائي؟ خطأ واضح؟).
  - التعامل مع أخطاء الشبكة/المصادقة.

---

## 4. اختبارات المتطلبات الوظيفية (Functional Requirements)

### 4.1 تجميع المتطلبات

يتم استخراج المتطلبات الوظيفية من الوثائق التالية:

- [`ARCHITECTURE.md`](mualleem-ai-tutor/ARCHITECTURE.md:1)
- [`RAG_IMPLEMENTATION.md`](mualleem-ai-tutor/backend/RAG_IMPLEMENTATION.md:1)
- [`REQUESTY_INTEGRATION.md`](mualleem-ai-tutor/REQUESTY_INTEGRATION.md:1)
- [`FRONTEND_COMPLETE.md`](mualleem-ai-tutor/FRONTEND_COMPLETE.md:1)

لكل متطلب:

- يُعطى معرف (ID) فريد مثل:
  - `FR-001`, `FR-002`, ...
- أمثلة عامة (يتم استكمالها فعلياً بعد قراءة الوثائق بالكامل):
  - `FR-001`: يجب أن يستطيع الطالب إرسال سؤال نصي والحصول على إجابة عربية مفهومة في أقل من 5 ثوانٍ في المتوسّط.
  - `FR-002`: يجب أن يدعم النظام رفع ملف PDF للمنهج وفهرسته في Qdrant.
  - `FR-003`: يجب أن يستطيع النظام استخدام RAG للإجابة عن الأسئلة من المنهج.
  - `FR-004`: يجب أن يكون هناك Endpoint `/health` يعيد حالة الخدمة.
  - `FR-005`: يجب أن تكون واجهة المحادثة باللغة العربية بالكامل وباتجاه RTL.

### 4.2 مصفوفة التتبع (Requirements Traceability Matrix)

إنشاء جدول يربط بين المتطلبات واختبارات التحقق:

| Req ID | الوصف | Test Case(s) | الحالة |
|--------|--------|--------------|--------|
| FR-001 | دعم سؤال نصي والحصول على إجابة عربية صحيحة | TC-F-01, TC-F-12 | Pending/Passed/Failed |
| FR-002 | دعم رفع منهج PDF وفهرسته في Qdrant | TC-F-04, TC-F-05, TC-F-06, TC-F-07, TC-F-11 | Pending/Passed/Failed |
| FR-003 | استخدام RAG للإجابة عن أسئلة المنهج | TC-F-08, TC-F-09 | Pending/Passed/Failed |
| FR-004 | توفر نقاط المراقبة `/health` و`/stats` | TC-F-10, TC-F-11 | Pending/Passed/Failed |
| FR-005 | واجهة عربية كاملة و RTL | اختبارات قسم 2.1–2.4 | Pending/Passed/Failed |

- يتم تحديث هذا الجدول تدريجياً مع تنفيذ الاختبارات وتسجيل نتائجها.

---

## 5. اختبارات الأداء والاستقرار (Performance & Stability)

### 5.1 اختبارات تحميل مبدئية

نقاط الاختبار:

- `/chat`
- `/upload-curriculum`
- `/stats`

أدوات مقترحة:

- `k6`
- `locust`
- سكربت Python بسيط باستخدام `asyncio` و `httpx` أو `requests`.

مثال سيناريو مبدئي لـ `/chat`:

- 10 مستخدمين متوازيين يرسلون أسئلة بسيطة (بدون صور) إلى `/chat` خلال 1–5 دقائق.
- قياس:
  - متوسط زمن الاستجابة (Average Latency).
  - زمن الاستجابة عند P95 (95th percentile).
  - معدل الأخطاء (Error Rate).

نقاط المراقبة:

- على السيرفر:
  - استهلاك CPU.
  - استهلاك RAM.
  - أي ارتفاع غير طبيعي في زمن الاستجابة مع زيادة الحمل.
- في اللوغ:
  - ظهور أخطاء متكررة.
  - timeouts أو مشاكل اتصالات مع Requesty/Qdrant.

### 5.2 استقرار النظام

اختبارات الاستقرار:

- تشغيل مستمر لـ backend و frontend لعدّة ساعات (مثلاً 6–12 ساعة) مع:
  - إرسال طلبات متفرقة لـ `/chat` و `/stats`.
  - تنفيذ عملية رفع منهج واحدة أو أكثر في بداية الاختبار.
- التحقق من:
  - عدم وجود memory leaks واضحة (ثبات أو استقرار نسبي في استخدام الذاكرة).
  - عدم تزايد الأخطاء في اللوغ بمرور الوقت.
  - استمرارية عمل الخدمات بدون الحاجة لإعادة تشغيل متكررة.

---

## 6. اختبارات الأمان (Security Testing) – إن كانت ضمن النطاق

### 6.1 الصلاحيات والوصول

- التحقق من:
  - عدم وجود مسارات إدارية حساسة مكشوفة بدون حماية (مثلاً مسارات لإعادة تهيئة Qdrant أو حذف بيانات).
  - إذا وُجد نظام مستخدمين:
    - تأكد من أن المستخدم غير المصرّح له لا يستطيع الوصول إلى بيانات أو عمليات ليست من صلاحياته.
  - عدم إمكانية تمرير أوامر أو إعدادات خطيرة عبر معلمات الـ API.

### 6.2 إدخال بيانات غير موثوقة

- اختبار حقول النص (مثل `question`):
  - إدخال نصوص تحتوي HTML/JS:
    - مثال: `<script>alert("XSS")</script>`
  - التحقق من:
    - أن الواجهة تعرض النص كما هو (escape) ولا تنفّذ JavaScript (منع XSS).
- اختبار حقول الرفع:
  - تجربة أسماء ملفات غير متوقعة (أسماء طويلة جداً، حروف خاصة، امتدادات مريبة).
  - رفع ملفات بأحجام ضخمة جداً:
    - التحقق من:
      - وجود حد أقصى للحجم.
      - رد فعل النظام برفض الملف برسالة واضحة دون انهيار.
- اختبار التعامل مع الإدخال غير الموثوق في استعلامات Qdrant:
  - التأكد من:
    - عدم وجود Injection واضح في تكوين الاستعلامات (معظم مكتبات Qdrant API آمنة افتراضياً).

### 6.3 توثيق أي ثغرات مكتشفة

لكل ثغرة يتم اكتشافها أثناء الاختبارات:

- توثيق:
  - ID: مثل `BUG-SEC-001`, `BUG-SEC-002`, ...
  - الوصف: ما هي الثغرة بالضبط؟ وما تأثيرها؟
  - خطوات إعادة الإنتاج خطوة بخطوة.
  - مدى الخطورة:
    - High: يمكن استغلالها للوصول إلى بيانات حساسة أو تعطيل الخدمة.
    - Medium: تؤثر على مجموعة من المستخدمين أو وظائف معينة.
    - Low: تأثير محدود أو صعب الاستغلال.
  - اقتراح إصلاح مبدئي:
    - مثل: فلترة إدخال، إضافة تحقق من الصلاحيات، تعديل إعدادات CORS، إلخ.

---

## 7. اختبارات القبول (User Acceptance / UAT Preparation)

### 7.1 سيناريوهات استخدام كاملة

تعريف 3–5 سيناريوهات من منظور الطالب/المعلّم. أمثلة:

1. **سيناريو: طالب يرفع منهج ويسأل أسئلة متتالية**
   - الخطوات:
     1. الحصول على ملف PDF لمنهج الرياضيات.
     2. رفع الـ PDF عبر واجهة رفع المنهج أو بأمر موثّق (curl).
     3. انتظار تأكيد الفهرسة (رسالة نجاح أو تحقق من `/stats`).
     4. فتح واجهة المحادثة.
     5. طرح 3 أسئلة مختلفة عن المنهج (مفاهيم/أمثلة/تطبيقات).
     6. تقييم جودة الإجابات من قبل شخص خبير في المادة.
   - معايير القبول:
     - أن تكون الإجابات منطقية ودقيقة بما يكفي للمستوى المستهدف.
     - عدم ظهور أخطاء تقنية أثناء التجربة.

2. **سيناريو: طالب يرسل صورة لمسألة صعبة**
   - الخطوات:
     1. تجهيز صورة لمسألة رياضية معقّدة (مثلاً سؤال في التفاضل أو الهندسة).
     2. فتح واجهة المحادثة ورفع الصورة.
     3. إضافة نص: `حل المسألة بالتفصيل`.
     4. إرسال الطلب.
     5. قراءة الإجابة والتأكد من:
        - صحة الحل.
        - وضوح الخطوات.
   - معايير القبول:
     - أن يكون الحل منطقياً ومتسلسلاً.
     - ألا تكون الإجابة مختصرة جداً أو غير مفهومة.

3. **سيناريو: استخدام المنصة على موبايل بإنترنت بطيء**
   - الخطوات:
     1. فتح المنصة من متصفح موبايل (أو محاكاة شبكة بطيئة من أدوات DevTools).
     2. إرسال عدة أسئلة نصية.
   - معايير القبول:
     - استمرار عمل المنصة دون تجمّد.
     - رسائل واضحة في حالة بطء الاستجابة (Loading، إعادة المحاولة، ...).

### 7.2 Checklist للقبول

إنشاء قائمة تحقق يمكن للعميل أو المالك النهائي للنظام استخدامها:

- [ ] يمكنني إرسال سؤال نصي والحصول على إجابة عربية مفهومة من واجهة المحادثة.
- [ ] يمكنني رفع منهج PDF (من خلال الواجهة أو الأداة الموثّقة) ورؤية أنه تم فهرسته في `/stats`.
- [ ] يمكنني طرح أسئلة عن محتوى المنهج المرفوع والحصول على إجابات تستند إلى المنهج.
- [ ] يمكنني رفع صورة لمسألة والحصول على تحليل منطقي مع خطوات واضحة.
- [ ] جميع الرسائل في الواجهة بالعربية وواضحة وسياقها صحيح.
- [ ] المنصة تعمل بشكل جيد على الموبايل والكمبيوتر.
- [ ] لا تظهر رسائل أخطاء تقنية خام للمستخدم النهائي.

---

## 8. التوثيق وتقارير النتائج (Documentation & Reporting)

### 8.1 توثيق حالات الاختبار

مكان حفظ وتوثيق Test Cases:

- يمكن توثيق الحالات النصية الأولية في هذا الملف `.next-tasks.md`.
- يمكن لاحقاً نقل الحالات إلى:
  - مجلد: `tests/functional/` في backend أو frontend (كسكربتات آلية).
  - أو أداة خارجية لإدارة الاختبارات مثل:
    - Jira + Xray.
    - TestRail.
    - أو Google Sheets منسّق.

### 8.2 حالة كل اختبار

لإدارة نتائج التنفيذ اليدوي، يمكن استخدام جدول بسيط مثل:

| Test Case ID | الحالة | ملاحظات |
|--------------|--------|---------|
| TC-F-01 | Passed | — |
| TC-F-02 | Failed | مشكلة في رفع الصورة على المتصفح X |
| TC-F-03 | Pending | لم يتم اختبار حالات الملفات الكبيرة بعد |
| ... | ... | ... |

الحالات الممكنة:

- `Pending`: لم يتم تنفيذ الاختبار بعد.
- `Passed`: تم تنفيذه ونجح.
- `Failed`: تم تنفيذه وفشل (مع ملاحظات).
- `Blocked`: لا يمكن تنفيذه حالياً بسبب عائق (مثل عدم توافر بيئة أو بيانات).

### 8.3 توثيق الـ Bugs

لكل Bug يتم اكتشافه أثناء تنفيذ الاختبارات:

- عناصر التوثيق:
  - ID: `BUG-001`, `BUG-002`, ... (أو تقسيم إضافي مثل `BUG-FE-001`, `BUG-BE-001`).
  - الوصف: ملخّص الخطأ (مثلاً: "كسر في واجهة المحادثة عند رفع صورة كبيرة").
  - خطوات إعادة الإنتاج (Reproduction Steps) خطوة بخطوة.
  - البيئة:
    - عنوان السيرفر/النسخة.
    - نوع المتصفح/الإصدار (لأخطاء الواجهة).
  - الـ Logs ذات الصلة:
    - مقتطفات من لوغ backend.
    - لقطات شاشة من console المتصفح أو Network.
  - أولوية الإصلاح:
    - High / Medium / Low.
  - الحالة:
    - Open / In Progress / Resolved / Rejected.

---

## 9. خطة التنفيذ والأولوية (Execution Plan & Prioritization)

### 9.1 أولوية الاختبارات

تقسيم الاختبارات إلى أولويات:

- **حرجة (Critical):**
  - اختبارات `/chat` النصية (مع وبدون RAG + مع Requesty).
  - اختبارات `/upload-curriculum` وتكاملها مع Qdrant.
  - اختبارات `/health` و `/stats`.
  - السيناريوهات الكاملة للطالب (رفع منهج → طرح أسئلة).

- **مهمة (High):**
  - اختبارات UI/UX لمسارات المستخدم الرئيسية على الأجهزة المختلفة.
  - اختبارات الأداء تحت حمل متوسط (10–20 مستخدم بالتوازي).
  - اختبارات أخطاء Requesty/Qdrant وكيفية عرضها للمستخدم.

- **ثانوية (Low):**
  - تحسينات واجهة صغيرة (ألوان، هوامش، تجميلات بصرية).
  - سيناريوهات نادرة (مثل رفع عدة مناهج في وقت واحد إن لم يكن هذا الاستخدام أساسياً).
  - دعم متصفحات قديمة إن لم تكن ضمن النطاق المتفق عليه.

### 9.2 جدول زمني مقترح

مثال جدول زمني على أساس أسابيع (يمكن تعديله حسب حجم الفريق):

- **الأسبوع 1:**
  - قراءة وتثبيت فهم جميع الوثائق:
    - [`ARCHITECTURE.md`](mualleem-ai-tutor/ARCHITECTURE.md:1)
    - [`RAG_IMPLEMENTATION.md`](mualleem-ai-tutor/backend/RAG_IMPLEMENTATION.md:1)
    - [`REQUESTY_INTEGRATION.md`](mualleem-ai-tutor/REQUESTY_INTEGRATION.md:1)
    - [`FRONTEND_COMPLETE.md`](mualleem-ai-tutor/FRONTEND_COMPLETE.md:1)
  - إعداد وتوثيق جميع الـ Test Cases للأقسام 1–4 في هذا الملف أو نظام إدارة الاختبارات.
- **الأسبوع 2:**
  - تنفيذ اختبارات التكامل بين:
    - Frontend و Backend.
    - Backend و Requesty.
    - Backend و Qdrant.
  - تنفيذ أول جولة من اختبارات الأداء المبدئية.
- **الأسبوع 3:**
  - معالجة الـ Bugs الحرجة وذات الأولوية العالية.
  - إعادة تنفيذ الاختبارات التي فشلت (Regression Testing).
  - تحسين الرسائل العربية وتجربة المستخدم بناءً على ملاحظات الاختبار.
- **الأسبوع 4:**
  - تنفيذ اختبارات القبول (UAT) مع العميل أو ممثلي المستخدمين.
  - جمع الملاحظات النهائية.
  - إعداد تقرير نهائي بحالة المشروع (Passed/Blocked على مستوى المتطلبات الرئيسية).

### 9.3 ما يمكن أتمتته (Automated Tests) لاحقاً

اقتراح ما يمكن تحويله إلى اختبارات آلية في مراحل لاحقة:

- اختبارات API (باستخدام `pytest` + `httpx` أو أدوات أخرى) لـ:
  - `/chat`
  - `/upload-curriculum`
  - `/stats`
  - `/health`
- اختبارات RAG ووظائف Qdrant:
  - باستخدام ملفات في `tests/` للتحقق من:
    - أن البحث في Qdrant يعيد النتائج المتوقعة لسؤال معيّن.
- اختبارات E2E للواجهة (باستخدام Playwright أو Cypress):
  - سيناريوهات:
    - فتح الصفحة الأساسية.
    - إرسال سؤال نصي.
    - انتظار الرد والتحقق من ظهور النص الصحيح.
    - (لاحقاً) سيناريوهات رفع PDF وصورة.
- ملاحظات:
  - المرحلة الحالية قد تركز على الاختبار اليدوي، مع تصميم الـ Test Cases بشكل يسهل تحويله لاحقاً إلى سكربتات آلية.
  - يفضّل البدء باختبارات API الحرجة أولاً، ثم اختبارات E2E.

---

## خاتمة

هذه الخطة تهدف إلى توفير دليل عمل عملي ومفصّل لتجربة واختبار نظام "معلّم" على مستوى:

- الوظائف الأساسية (الدردشة النصية، الصور، RAG، رفع المناهج).
- تكامل المكوّنات (Frontend, Backend, Requesty, Qdrant).
- تجربة المستخدم باللغة العربية.
- الأداء والاستقرار والأمان (بالمستوى المناسب لنطاق المشروع الحالي).

هذه الخطة قابلة للتوسعة مع تطوّر المشروع، وعند إضافة أية خاصية جديدة يجب:

1. تحديث قسم 1.1 بإضافة وصف للخاصية الجديدة ومساراتها.
2. إضافة حالات اختبار جديدة في قسم 1.2 وما بعده.
3. تحديث مصفوفة المتطلبات (Section 4.2) بمتطلبات جديدة إن وُجدت.
4. إضافة سيناريوهات UAT جديدة إن كانت الخاصية تمسّ تجربة المستخدم بشكل واضح.

بهذا الشكل، يصبح ملف `.next-tasks.md` مرجعاً جاهزاً للمبرمج/فريق الاختبار لتنفيذ واكمال جميع الاختبارات على مستوى النظام قبل أي إطلاق أو تسليم رسمي.